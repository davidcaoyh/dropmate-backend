apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-initdb-sql
  # SQL scripts placed here will be mounted into the Postgres image
  # and executed on first initialization by the official postgres/docker-entrypoint.sh
data:
  01_init_schema.sql: |-
    -- =====================================================
    -- DropMate Database Schema
    -- =====================================================

    -- Extensions
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    -- =====================================================
    -- Core Tables
    -- =====================================================

    -- Users table (for authentication)
    CREATE TABLE IF NOT EXISTS users (
        id SERIAL PRIMARY KEY,
        email VARCHAR(255) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        role VARCHAR(50) NOT NULL DEFAULT 'customer',
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );

    -- Customers
    CREATE TABLE IF NOT EXISTS customers (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
        name VARCHAR(255) NOT NULL,
        phone VARCHAR(50),
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );

    -- Drivers
    CREATE TABLE IF NOT EXISTS drivers (
        id SERIAL PRIMARY KEY,
        user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
        name VARCHAR(255) NOT NULL,
        vehicle_type VARCHAR(100),
        license_number VARCHAR(100),
        status VARCHAR(50) DEFAULT 'offline',
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );

    -- Orders
    CREATE TABLE IF NOT EXISTS orders (
        id SERIAL PRIMARY KEY,
        customer_id INTEGER REFERENCES customers(id) ON DELETE CASCADE,
        total_amount DECIMAL(10, 2),
        status VARCHAR(50) DEFAULT 'pending',
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );

    -- Shipments (packages)
    CREATE TABLE IF NOT EXISTS shipments (
        id SERIAL PRIMARY KEY,
        order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,
        driver_id INTEGER REFERENCES drivers(id) ON DELETE SET NULL,
        tracking_number VARCHAR(100) UNIQUE NOT NULL,
        status VARCHAR(50) DEFAULT 'pending',
        pickup_address TEXT,
        delivery_address TEXT,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_shipments_driver_id ON shipments(driver_id);
    CREATE INDEX IF NOT EXISTS idx_shipments_tracking_number ON shipments(tracking_number);

    -- =====================================================
    -- Event/Tracking Tables (Partitioned for scalability)
    -- =====================================================

    -- Driver Location Events (high-frequency writes)
    CREATE TABLE IF NOT EXISTS driver_location_events (
        id BIGSERIAL,
        driver_id INTEGER NOT NULL REFERENCES drivers(id) ON DELETE CASCADE,
        latitude DECIMAL(10, 8) NOT NULL,
        longitude DECIMAL(11, 8) NOT NULL,
        accuracy DECIMAL(6, 2),
        occurred_at TIMESTAMP DEFAULT NOW(),
        PRIMARY KEY (id, occurred_at)
    ) PARTITION BY RANGE (occurred_at);

    CREATE INDEX IF NOT EXISTS idx_driver_location_driver_time
        ON driver_location_events(driver_id, occurred_at DESC);

    -- Shipment Events (status changes, milestones)
    CREATE TABLE IF NOT EXISTS shipment_events (
        id BIGSERIAL,
        shipment_id INTEGER NOT NULL REFERENCES shipments(id) ON DELETE CASCADE,
        event_type VARCHAR(50) NOT NULL,
        description TEXT,
        latitude DECIMAL(10, 8),
        longitude DECIMAL(11, 8),
        occurred_at TIMESTAMP DEFAULT NOW(),
        PRIMARY KEY (id, occurred_at)
    ) PARTITION BY RANGE (occurred_at);

    CREATE INDEX IF NOT EXISTS idx_shipment_events_shipment_time
        ON shipment_events(shipment_id, occurred_at DESC);

    -- Webhook Events
    CREATE TABLE IF NOT EXISTS webhook_events (
        id BIGSERIAL,
        event_type VARCHAR(100) NOT NULL,
        payload JSONB,
        status VARCHAR(50) DEFAULT 'pending',
        occurred_at TIMESTAMP DEFAULT NOW(),
        PRIMARY KEY (id, occurred_at)
    ) PARTITION BY RANGE (occurred_at);

    -- Ad Impressions
    CREATE TABLE IF NOT EXISTS ad_impressions (
        id BIGSERIAL,
        ad_id INTEGER,
        user_id INTEGER,
        occurred_at TIMESTAMP DEFAULT NOW(),
        PRIMARY KEY (id, occurred_at)
    ) PARTITION BY RANGE (occurred_at);

    -- Messages
    CREATE TABLE IF NOT EXISTS messages (
        id SERIAL PRIMARY KEY,
        sender_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
        recipient_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
        shipment_id INTEGER REFERENCES shipments(id) ON DELETE CASCADE,
        message TEXT NOT NULL,
        read BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT NOW()
    );

    CREATE INDEX IF NOT EXISTS idx_messages_shipment ON messages(shipment_id);
    CREATE INDEX IF NOT EXISTS idx_messages_recipient ON messages(recipient_id, read);

  08_partitioning.sql: |-
    -- Default partitions to ensure writes succeed before rolling maintenance jobs add time-based partitions.

    CREATE TABLE IF NOT EXISTS ad_impressions_default
        PARTITION OF ad_impressions DEFAULT;

    CREATE TABLE IF NOT EXISTS driver_location_events_default
        PARTITION OF driver_location_events DEFAULT;

    CREATE TABLE IF NOT EXISTS shipment_events_default
        PARTITION OF shipment_events DEFAULT;

    CREATE TABLE IF NOT EXISTS webhook_events_default
        PARTITION OF webhook_events DEFAULT;



    -- Suggested helper: create_monthly_partitions('ad_impressions', 'occurred_at', '2024-01-01');
    -- Implement partition management logic in background jobs or external automation.


